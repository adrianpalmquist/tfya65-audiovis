<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ljudtest</title>
</head>

<body>
    <div class="wrapper">
        <canvas class="visualizer"</canvas>

            <form class="controls">
          <div>
            <label for="filter">Filter setting</label>
            <select id="filter" name="filter">
              <option value="distortion">Distortion</option>
              <option value="convolver">Reverb</option>
              <option value="biquad" selected>Bass Boost</option>
              <option value="off">Off</option>
            </select>
          </div>


        <script>
        var context;
        var bufferLoader;
        var audioCtx = null;
        var analyser = null;
        var biquadFilter = null;
        var distortion = null;
        var gainNode = null;
        var convolver = null;
        var concertHallBuffer = null;
        var musicData = null;
        var bufferLength = null;
        var canvas = null;
        var canvasCtx = null;
        var intendedWidth = null;
        var WIDTH = 640;
        var HEIGHT = 360;
        var filterSelect = null;
        var drawVisual;
        window.onload = init;
        function init() {
            audioCtx = new(window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            biquadFilter = audioCtx.createBiquadFilter();
            distortion = audioCtx.createWaveShaper();
            gainNode = audioCtx.createGain();
            convolver = audioCtx.createConvolver();

            analyser.connect(audioCtx.destination);
            gainNode.connect(analyser);
            //convolver.connect(gainNode);
            biquadFilter.connect(gainNode);
            distortion.connect(biquadFilter);


            analyser.minDecibels = -120;
            analyser.maxDecibels = 0;
            filterSelect = document.getElementById("filter");

            intendedWidth = document.querySelector('.wrapper').clientWidth;
            audioFileUrl = 'sounds/example.mp3';
            var request = new XMLHttpRequest();
            request.open("GET", audioFileUrl, true);
            request.responseType = "arraybuffer";
            // Our asynchronous callback
            request.onload = function() {
                audioCtx.decodeAudioData(request.response, function(buffer) {
                    concertHallBuffer = buffer;
                    filterChange();
                    processDecodedAudio(buffer);
                },
                function(error) {
                    console.error('decodedAudioData error', error);
                });
            };
            request.send();
        }
        function processDecodedAudio(buffer) {
            musicData = new Uint8Array(analyser.frequencyBinCount);
            playSound(buffer);
            draw();
        }
        function playSound(buffer) {
            var source = audioCtx.createBufferSource(); // Declare a New Sound
            source.connect(distortion);
            source.buffer = buffer; // Attatch our Audio Data as it's Buffer
            //source.loop = true;
            //source.connect(audioCtx.destination); // Link the Sound to the Output
            source.start(0);
        }
        function makeDistortionCurve(amount) {
            var k = typeof amount === 'number' ? amount : 50,
            n_samples = 44100,
            curve = new Float32Array(n_samples),
            deg = Math.PI / 180,
            i = 0,
            x;
        for ( ; i < n_samples; ++i ) {
            x = i * 2 / n_samples - 1;
            curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
        };

        function filterChange() {
  
          distortion.oversample = '4x';
          biquadFilter.gain.value = 0;
          convolver.buffer = undefined;

          var filterSetting = filterSelect.value;
          console.log(filterSetting);

          if(filterSetting == "distortion") {
            distortion.curve = makeDistortionCurve(400);
          } else if(filterSetting == "convolver") {
            console.log("Filter: Reverb")
            convolver.buffer = concertHallBuffer;
          } else if(filterSetting == "biquad") {
            console.log("Filter: lowshelf");
            biquadFilter.type = "highpass";
            biquadFilter.frequency.value = 12000;
            //biquadFilter.gain.value = 25;
          } else if(filterSetting == "off") {
            console.log("Filter settings turned off");
          }

        }
/*
        filterSelect.onchange = function() {
        filterChange();
        }
*/


        function draw() {
            analyser.smoothingTimeConstant = 0.8;
            analyser.fftSize = 2048;
            var canvas = document.querySelector('.visualizer');
            var canvasCtx = canvas.getContext("2d");
            drawVisual = requestAnimationFrame(draw);
            analyser.getByteFrequencyData(musicData);
            //analyser.getByteTimeDomainData(musicData);
            var width = Math.floor(1 / musicData.length, 10);
            canvas.width = WIDTH;
            canvas.height = HEIGHT;
            for (var i = 0; i < analyser.frequencyBinCount; i++) {
                var value = musicData[i];
                var percent = value / 256;
                var height = HEIGHT * percent;
                var offset = HEIGHT - height - 1;
                var barWidth = WIDTH / analyser.frequencyBinCount;
                var hue = i / analyser.frequencyBinCount * 360;
                canvasCtx.fillStyle = 'hsl(' + hue + ', 100%, 50%)';
                canvasCtx.fillRect(i * barWidth, offset, barWidth, height);
            }
        }
        </script>
    </div>
</body>

</html>